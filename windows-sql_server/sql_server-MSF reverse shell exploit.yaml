title: Metasploit reverse shell injection in SQL Server
description: Detects scenarios where an attacker inject a payload into SQL Server in order to obtain a remote shell.
references:
- https://attack.mitre.org/techniques/T1059/003/
- https://github.com/mdecrevoisier/EVTX-to-MITRE-Attack/tree/master/TA0002-Execution/T1059.003-Windows%20Command%20Shell
- https://www.offensive-security.com/metasploit-unleashed/payloads-mssql/#
- https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688
tags:
- attack.execution
- attack.t1059.003
author: mdecrevoisier
status: experimental
logsource:
  product: windows
  category: process_creation
detection:
  selection:
    EventID: 4688
    Version: 2  # parent process name is available starting Windows 10 or higher (otherwise risk of false positive maybe higher)
    ParentProcessName|endswith: '\sqlservr.exe'
    NewProcessName|endswith:
    - '\cmd.exe'
    - '\pwsh.exe' # PowerShell core
    - '\powershell.exe'
    CommandLine|contains|all:
      - cmd.exe
      - echo
  condition: selection
falsepositives:
- none
level: high